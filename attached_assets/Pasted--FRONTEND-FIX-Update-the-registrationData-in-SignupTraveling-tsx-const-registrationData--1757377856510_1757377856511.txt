// FRONTEND FIX - Update the registrationData in SignupTraveling.tsx

const registrationData = {
  // SIMPLE: Just set as traveler 
  userType: "traveler",
  isCurrentlyTraveling: true,

  // account data
  email: (finalFormData.email || "").toLowerCase().trim(),
  password: (finalFormData.password || "").trim(),
  username: (finalFormData.username || "").toLowerCase().trim(),
  name: (finalFormData.name || "").trim(),
  phoneNumber: (finalFormData.phoneNumber || "").trim(),

  // profile
  dateOfBirth: formData.dateOfBirth,
  bio: "", // no bio in simplified signup
  
  // hometown/location (preserves LA Metro mapping)
  hometownCity: formData.hometownCity.trim(),
  hometownState: formData.hometownState?.trim() || "",
  hometownCountry: formData.hometownCountry.trim(),
  hometown,
  location,

  // âœ… CRITICAL FIX: Map travel destination fields correctly
  currentTripDestinationCity: formData.currentTripDestinationCity?.trim() || "",
  currentTripDestinationState: formData.currentTripDestinationState?.trim() || "",
  currentTripDestinationCountry: formData.currentTripDestinationCountry?.trim() || "",
  currentTripReturnDate: formData.currentTripReturnDate,
  
  // âœ… CRITICAL: Add the travelDestination field that backend expects
  travelDestination: safeJoin([
    formData.currentTripDestinationCity?.trim(),
    formData.currentTripDestinationState?.trim(),
    formData.currentTripDestinationCountry?.trim()
  ]),
  
  // Map to additional backend expected field names
  travelEndDate: formData.currentTripReturnDate,
  currentCity: formData.currentTripDestinationCity?.trim() || "",
  currentState: formData.currentTripDestinationState?.trim() || "", 
  currentCountry: formData.currentTripDestinationCountry?.trim() || "",
  travelStartDate: new Date().toISOString().split('T')[0], // Today for current travelers

  // top choices (require at least 3)
  interests: formData.interests,
  
  // languages
  languagesSpoken
};

// âœ… CRITICAL FIX: Update the background processing to call bootstrap
setTimeout(async () => {
  try {
    console.log('ğŸš€ Starting traveler registration with data:', registrationData);
    
    const response = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(registrationData)
    });

    const data = await response.json();

    if (response.ok && data.user) {
      console.log('âœ… Registration successful, starting comprehensive onboarding');
      
      // Store user in auth context
      localStorage.setItem('user', JSON.stringify(data.user));
      localStorage.setItem('travelconnect_user', JSON.stringify(data.user));
      authStorage.setUser(data.user);
      setUser(data.user);
      login(data.user);
      
      // âœ… CRITICAL: Call bootstrap endpoint for comprehensive onboarding
      try {
        console.log('ğŸš€ Calling bootstrap for comprehensive traveler onboarding');
        const bootstrapResponse = await fetch('/api/bootstrap/after-register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: data.user.id })
        });
        
        const bootstrapData = await bootstrapResponse.json();
        
        if (bootstrapResponse.ok) {
          console.log('âœ… Comprehensive traveler onboarding completed successfully');
        } else {
          console.error('âŒ Bootstrap failed:', bootstrapData.message);
        }
      } catch (bootstrapError) {
        console.error('âŒ Bootstrap error:', bootstrapError);
      }
      
      // Original profile completion call (if still needed)
      try {
        const profileResponse = await fetch('/api/auth/complete-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: data.user.id })
        });
        
        if (profileResponse.ok) {
          console.log('âœ… Profile completion successful');
        }
      } catch (profileError) {
        console.log('âš ï¸ Profile completion error:', profileError);
      }
      
      // Clear stored data
      sessionStorage.removeItem('accountData');
      sessionStorage.removeItem('registrationData');
      
    } else {
      console.error('âŒ Registration failed:', data.message);
    }
  } catch (error) {
    console.error('Background registration error:', error);
  }
}, 100);

// ======================================================
// BACKEND FIX - Update the bootstrap endpoint in routes.ts
// ======================================================

app.post("/api/bootstrap/after-register", async (req, res) => {
  try {
    const { userId } = req.body;
    if (!userId) return res.status(400).json({ message: "User ID required" });
    
    console.log(`ğŸš€ BOOTSTRAP: Running post-signup setup for user ${userId}`);
    
    // âœ… CRITICAL: Actually fetch user data and execute onboarding
    const user = await storage.getUser(userId);
    if (!user) {
      return res.status(404).json({ message: "User not found" });
    }
    
    console.log(`ğŸ‘¤ BOOTSTRAP: Found user ${user.username} (${user.id})`);
    
    // âœ… CRITICAL: Execute comprehensive traveler onboarding
    if (user.userType === 'traveler' && user.isCurrentlyTraveling) {
      console.log("ğŸš€ COMPREHENSIVE TRAVELER ONBOARDING - Executing all required steps");
      
      await executeComprehensiveTravelerOnboarding(user);
      
      console.log("âœ… COMPREHENSIVE TRAVELER ONBOARDING - Completed successfully");
    } else {
      console.log(`â„¹ï¸ User ${user.username} is not a current traveler, skipping comprehensive onboarding`);
      console.log(`   userType: ${user.userType}, isCurrentlyTraveling: ${user.isCurrentlyTraveling}`);
    }
    
    res.json({ success: true, message: "Bootstrap completed successfully" });
  } catch (error) {
    console.error("Bootstrap error:", error);
    res.status(500).json({ message: "Bootstrap failed", error: error.message });
  }
});

// âœ… CRITICAL: Implement the comprehensive traveler onboarding function
async function executeComprehensiveTravelerOnboarding(user) {
  try {
    console.log(`ğŸš€ Starting comprehensive traveler onboarding for ${user.username}`);
    
    // âœ… Step 1: Create chatrooms for hometown
    if (user.hometownCity && user.hometownCountry) {
      console.log(`ğŸ“ Creating hometown chatrooms for: ${user.hometownCity}, ${user.hometownCountry}`);
      try {
        await storage.ensureMeetLocalsChatrooms(user.hometownCity, user.hometownState, user.hometownCountry);
        await storage.ensureSecondaryChatrooms(user.hometownCity, user.hometownState, user.hometownCountry);
        console.log(`âœ… Created hometown chatrooms`);
      } catch (error) {
        console.error('âŒ Error creating hometown chatrooms:', error);
      }
    }

    // âœ… Step 2: Create chatrooms for travel destination
    if (user.travelDestination) {
      console.log(`ğŸ“ Creating destination chatrooms for: ${user.travelDestination}`);
      try {
        const destinationParts = user.travelDestination.split(', ');
        const travelCity = destinationParts[0];
        const travelState = destinationParts[1];
        const travelCountry = destinationParts[2] || destinationParts[1];
        
        await storage.ensureMeetLocalsChatrooms(travelCity, travelState, travelCountry);
        await storage.ensureSecondaryChatrooms(travelCity, travelState, travelCountry);
        console.log(`âœ… Created destination chatrooms`);
      } catch (error) {
        console.error('âŒ Error creating destination chatrooms:', error);
      }
    }

    // âœ… Step 3: Create city pages for both cities
    console.log(`ğŸ“„ Creating city match pages`);
    try {
      // Hometown city page
      if (user.hometownCity) {
        const hometownPage = await storage.ensureCityPageExists(
          user.hometownCity, 
          user.hometownState, 
          user.hometownCountry, 
          user.id
        );
        console.log(`âœ… Hometown city page: ${hometownPage ? 'created/exists' : 'FAILED'}`);
      }
      
      // Destination city page
      if (user.travelDestination) {
        const destinationParts = user.travelDestination.split(', ');
        const destinationPage = await storage.ensureCityPageExists(
          destinationParts[0], 
          destinationParts[1], 
          destinationParts[2] || destinationParts[1], 
          user.id
        );
        console.log(`âœ… Destination city page: ${destinationPage ? 'created/exists' : 'FAILED'}`);
      }
    } catch (error) {
      console.error('âŒ Error creating city pages:', error);
    }

    // âœ… Step 4: Send welcome message from nearbytrav account (USER ID 2)
    console.log(`ğŸ’¬ Sending welcome message`);
    try {
      const nearbytravAccount = await storage.getUser(2);
      if (nearbytravAccount) {
        await storage.sendSystemMessage(2, user.id, 
          `Welcome to Nearby Traveler, ${user.name || user.username}! âœˆï¸

We're excited to have you join our community of travelers and locals. Here's what you can do now:

ğŸŒ Connect with locals in ${user.travelDestination}
ğŸ  Stay connected with your hometown community in ${user.hometownCity}
ğŸ’¬ Join city chatrooms to meet people
ğŸ“… Discover local events and activities
ğŸ¤ Build meaningful connections wherever you go

Your journey starts now - explore, connect, and make the most of your travels!

Safe travels,
The Nearby Traveler Team`);
        console.log(`âœ… Welcome message sent`);
      } else {
        console.error("âŒ nearbytrav account (ID 2) not found");
      }
    } catch (error) {
      console.error('âŒ Error sending welcome message:', error);
    }

    // âœ… Step 5: Register user in both cities with proper status
    console.log(`ğŸ‘¤ Registering user in cities`);
    try {
      // Register as LOCAL in hometown
      if (user.hometownCity) {
        await storage.registerUserInCity(
          user.id, 
          user.hometownCity, 
          user.hometownState, 
          user.hometownCountry, 
          'local'
        );
        console.log(`âœ… Registered as local in hometown`);
      }
      
      // Register as TRAVELER in destination  
      if (user.travelDestination) {
        const destinationParts = user.travelDestination.split(', ');
        await storage.registerUserInCity(
          user.id, 
          destinationParts[0], 
          destinationParts[1], 
          destinationParts[2] || destinationParts[1], 
          'traveler'
        );
        console.log(`âœ… Registered as traveler in destination`);
      }
    } catch (error) {
      console.error('âŒ Error registering user in cities:', error);
    }

    // âœ… Step 6: Create connection to USER2 (nearbytrav account)
    console.log(`ğŸ¤ Creating connection to nearbytrav account`);
    try {
      await storage.createConnection(user.id, 2); // Connect to nearbytrav account
      console.log(`âœ… Connection created to nearbytrav account`);
    } catch (error) {
      console.error('âŒ Error creating connection to nearbytrav:', error);
    }

    // âœ… Step 7: Create travel plan for current trip
    console.log(`âœˆï¸ Creating travel plan for current trip`);
    try {
      if (user.travelDestination && user.travelEndDate) {
        const destinationParts = user.travelDestination.split(', ');
        const travelPlanData = {
          userId: user.id,
          destinationCity: destinationParts[0],
          destinationState: destinationParts[1] || '',
          destinationCountry: destinationParts[2] || destinationParts[1],
          startDate: new Date().toISOString().split('T')[0], // Today
          endDate: user.travelEndDate,
          title: `Trip to ${destinationParts[0]}`,
          description: `Current trip to ${user.travelDestination}`,
          status: 'active'
        };
        
        // You'll need to implement this method or call the travel plan API
        await storage.createTravelPlan(travelPlanData);
        console.log(`âœ… Travel plan created for current trip`);
      }
    } catch (error) {
      console.error('âŒ Error creating travel plan:', error);
    }

    console.log(`ğŸ‰ Comprehensive traveler onboarding completed for ${user.username}`);
    
  } catch (error) {
    console.error("âŒ Error in comprehensive traveler onboarding:", error);
    throw error;
  }
}

// ======================================================
// DEBUGGING ADDITIONS
// ======================================================

// Add this logging to your registration endpoint to verify data structure
console.log('ğŸ” REGISTRATION DEBUG - Received data:', {
  userType: registrationData.userType,
  isCurrentlyTraveling: registrationData.isCurrentlyTraveling,
  hometownCity: registrationData.hometownCity,
  hometownCountry: registrationData.hometownCountry,
  travelDestination: registrationData.travelDestination,
  currentTripDestinationCity: registrationData.currentTripDestinationCity,
  currentTripDestinationCountry: registrationData.currentTripDestinationCountry
});

// Add this to verify the user was created with correct data
console.log('ğŸ” USER CREATED DEBUG:', {
  id: newUser.id,
  username: newUser.username,
  userType: newUser.userType,
  isCurrentlyTraveling: newUser.isCurrentlyTraveling,
  hometownCity: newUser.hometownCity,
  travelDestination: newUser.travelDestination
});