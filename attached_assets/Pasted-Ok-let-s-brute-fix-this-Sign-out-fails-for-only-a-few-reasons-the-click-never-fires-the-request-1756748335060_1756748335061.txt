Ok—let’s brute-fix this. “Sign out” fails for only a few reasons: the click never fires, the request is blocked (no credentials), the server doesn’t destroy the session / cookie isn’t cleared, or your auth-gate instantly logs you back in. Do these steps exactly:

1) Server: make logout bulletproof

Ensure your logout route both destroys the session and clears the cookie with the same options you used when creating it.

// session setup (dev on Replit)
import session from "express-session";

app.set("trust proxy", 1); // ok on Replit
const COOKIE_NAME = "connect.sid";

app.use(session({
  name: COOKIE_NAME,
  secret: process.env.SESSION_SECRET || "devsecret",
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    sameSite: "lax",
    secure: false,          // true only behind HTTPS
    maxAge: 1000 * 60 * 60 * 24 * 7,
    path: "/",
  },
}));

// LOGOUT
app.post("/api/auth/logout", (req, res) => {
  const cookieOpts = { path: "/", sameSite: "lax", secure: false, httpOnly: true };
  req.session?.destroy((err) => {
    if (err) console.error("Session destroy error:", err);
    res.clearCookie(COOKIE_NAME, cookieOpts);
    return res.status(200).json({ ok: true });
  });
});

// QUICK DEBUG (optional)
app.get("/api/auth/whoami", (req, res) => {
  res.json({ user: req.session?.user || null });
});


If you originally set secure: true or a custom domain/path, match those in clearCookie or the cookie won’t clear.

2) Client: guaranteed click + credentials + state clear

Put this exact handler on your Sign out button (not inside a <Link>). If it lives in a menu/sheet, close the menu first, then run logout in a setTimeout.

import { useLocation } from "wouter";
import { useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/App";
import { authStorage } from "@/lib/auth";

function SignOutButton({ closeMenu }: { closeMenu?: () => void }) {
  const [, setLocation] = useLocation();
  const qc = useQueryClient();
  const { setUser } = useAuth();

  async function doLogout() {
    try {
      const res = await fetch("/api/auth/logout", {
        method: "POST",
        credentials: "include",               // CRITICAL
        headers: { "Content-Type": "application/json" },
      });
      if (!res.ok) throw new Error("logout failed");
    } catch (_) {
      // ignore; we’ll still clear client state
    } finally {
      authStorage?.clear?.();                // clear tokens/localStorage
      qc.clear();                            // clear react-query cache
      setUser?.(null);                       // clear context
      // Hard reload to drop any stale client state
      window.location.replace("/signin");    // or setLocation("/signin")
    }
  }

  return (
    <button
      type="button"
      className="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
      onClick={(e) => {
        e.preventDefault();
        e.stopPropagation();
        closeMenu?.();
        setTimeout(doLogout, 0);
      }}
    >
      Sign out
    </button>
  );
}

3) Menu/backdrop can’t eat the click

If you have a full-screen overlay:

{/* Backdrop */}
<div className="fixed inset-0 bg-black/40 pointer-events-none" />
{/* Panel */}
<div className="fixed right-0 top-16 z-50 pointer-events-auto">...</div>


Or ensure panel z-50 is higher than backdrop and don’t nest the signout button inside an <a> or <Link>.

4) Auth gate: redirect to /signin, never auto-login

Your bootstrap should only redirect unauthenticated users to /signin and must not call /api/login anywhere.

useEffect(() => {
  let cancelled = false;
  (async () => {
    try {
      const me = await fetch("/api/auth/user", { credentials: "include" }).then(r => {
        if (!r.ok) throw 0;
        return r.json();
      });
      if (!cancelled) setUser(me);
    } catch {
      if (!cancelled) setUser(null);
      if (location.pathname !== "/signin") setLocation("/signin");
    }
  })();
  return () => { cancelled = true; };
}, [location.pathname]);

5) Quick diagnostics (2 minutes)

Network tab: click “Sign out” → you must see POST /api/auth/logout (Status 200).
If you see 401/403/0 → check credentials: 'include' and CORS.

Cookie check: DevTools → Application → Cookies → look for connect.sid. After logout it should disappear. If not, your clearCookie options don’t match—fix step #1.

Whoami: visit /api/auth/whoami before and after logout: should flip from a user object to null.

Hard reload: Cmd/Ctrl-Shift-R after changes to bypass any service worker/cache.

6) Most common gotchas (fix if any match)

fetch missing credentials: 'include' → server never receives session cookie.

res.clearCookie missing matching options or wrong cookie name.

Button inside <Link> or form without type="button" → event hijacked.

Menu unmounts before handler runs → use setTimeout(doLogout, 0) after closing.

An “auto-login” dev helper still runs somewhere (remove any /api/login redirects).

If you paste your express-session config and the JSX where the sign-out button lives, I’ll mark exact one-line fixes.