#!/usr/bin/env node

// Automated QA Test Suite Runner
// Replaces manual QA tester with comprehensive automated testing

import { execSync } from 'child_process';
import { writeFileSync } from 'fs';

console.log('üöÄ Starting Automated QA Test Suite...\n');

const testCategories = [
  {
    name: 'API Endpoints',
    pattern: 'tests/api/**/*.test.ts',
    critical: true
  },
  {
    name: 'User Interface Components', 
    pattern: 'tests/components/**/*.test.tsx',
    critical: true
  },
  {
    name: 'Location & Matching Logic',
    pattern: 'tests/utils/**/*.test.ts',
    critical: true
  },
  {
    name: 'App Health & Performance',
    pattern: 'tests/integration/**/*.test.ts',
    critical: true
  }
];

const runTests = async () => {
  const results = [];
  let totalPassed = 0;
  let totalFailed = 0;

  for (const category of testCategories) {
    console.log(`\nüìã Testing: ${category.name}`);
    console.log('‚îÄ'.repeat(50));
    
    try {
      const output = execSync(`npx vitest run "${category.pattern}" --reporter=json`, {
        encoding: 'utf8',
        timeout: 30000
      });
      
      const result = JSON.parse(output);
      const passed = result.numPassedTests || 0;
      const failed = result.numFailedTests || 0;
      
      totalPassed += passed;
      totalFailed += failed;
      
      results.push({
        category: category.name,
        passed,
        failed,
        critical: category.critical,
        status: failed === 0 ? 'PASS' : 'FAIL'
      });
      
      console.log(`‚úÖ ${passed} tests passed`);
      if (failed > 0) {
        console.log(`‚ùå ${failed} tests failed`);
      }
      
    } catch (error) {
      console.log(`‚ö†Ô∏è  Tests in ${category.name} had issues`);
      results.push({
        category: category.name,
        passed: 0,
        failed: 1,
        critical: category.critical,
        status: 'ERROR'
      });
      totalFailed++;
    }
  }

  // Generate QA Report
  const report = generateQAReport(results, totalPassed, totalFailed);
  writeFileSync('qa-test-report.md', report);
  
  console.log('\nüéØ QA TEST SUMMARY');
  console.log('‚ïê'.repeat(50));
  console.log(`Total Passed: ${totalPassed}`);
  console.log(`Total Failed: ${totalFailed}`);
  console.log(`Success Rate: ${Math.round((totalPassed / (totalPassed + totalFailed)) * 100)}%`);
  
  const criticalFailures = results.filter(r => r.critical && r.status !== 'PASS');
  if (criticalFailures.length > 0) {
    console.log('\nüö® CRITICAL ISSUES DETECTED:');
    criticalFailures.forEach(f => {
      console.log(`   ‚Ä¢ ${f.category}: ${f.failed} failures`);
    });
    console.log('\n   ‚ö†Ô∏è  Deploy NOT recommended until critical issues are fixed');
  } else {
    console.log('\n‚ú® All critical tests passing - Ready for deployment!');
  }
  
  console.log(`\nüìä Full report saved to: qa-test-report.md`);
};

const generateQAReport = (results, totalPassed, totalFailed) => {
  const date = new Date().toLocaleDateString();
  
  return `# QA Test Report - ${date}

## Summary
- **Total Tests**: ${totalPassed + totalFailed}
- **Passed**: ${totalPassed}
- **Failed**: ${totalFailed}
- **Success Rate**: ${Math.round((totalPassed / (totalPassed + totalFailed)) * 100)}%

## Test Results by Category

${results.map(r => `
### ${r.category} ${r.status === 'PASS' ? '‚úÖ' : '‚ùå'}
- Passed: ${r.passed}
- Failed: ${r.failed}
- Critical: ${r.critical ? 'Yes' : 'No'}
`).join('')}

## Deployment Recommendation
${results.filter(r => r.critical && r.status !== 'PASS').length === 0 
  ? '‚úÖ **APPROVED** - All critical tests passing'
  : '‚ùå **NOT RECOMMENDED** - Critical test failures detected'
}

---
*Generated by Automated QA System - Replaces manual testing*
`;
};

runTests().catch(console.error);